<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JellyNext Configuration</title>
    <style>
        .tabContent {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div id="JellyNextConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox,emby-tabs,embyRouter">
        <div data-role="content">
            <div class="content-primary">
                <form id="JellyNextConfigForm">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">JellyNext Configuration</h2>
                    </div>

                    <!-- Tabs -->
                    <div data-role="controlgroup" data-type="horizontal" class="localnav" style="margin-bottom: 2em;">
                        <a class="emby-button ui-btn-active" data-index="0" data-role="button">General</a>
                        <a type="button" class="emby-button" data-index="1" data-role="button">Trakt</a>
                        <a type="button" class="emby-button" data-index="2" data-role="button">Trending</a>
                        <a type="button" class="emby-button" data-index="3" data-role="button">Downloads</a>
                    </div>

                    <!-- Tab Content Containers (will be loaded dynamically) -->
                    <div class="tabContent" data-index="0"></div>
                    <div class="tabContent" data-index="1" style="display: none;"></div>
                    <div class="tabContent" data-index="2" style="display: none;"></div>
                    <div class="tabContent" data-index="3" style="display: none;"></div>

                    <!-- Save Button (outside all tabs) -->
                    <div style="margin-top: 2em;">
                        <button is="emby-button" type="submit" class="raised button-submit block">
                            <span>Save Configuration</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Shared utilities and main page logic -->
        <script type="text/javascript">
            // Shared utilities and global configuration
            var JellyNextConfig = {
                pluginUniqueId: 'a4df60c5-6ab4-412a-8f79-2cab93fb2bc5',
                currentUserGuid: null,
                authCheckInterval: null,
                radarrProfiles: [],
                radarrFolders: [],
                sonarrProfiles: [],
                sonarrFolders: [],
                jellyseerrRadarrServers: [],
                jellyseerrSonarrServers: [],
                jellyseerrRadarrProfiles: [],
                jellyseerrSonarrProfiles: [],
                // Store saved config values
                savedJellyseerrRadarrServerId: null,
                savedJellyseerrRadarrProfileId: null,
                savedJellyseerrSonarrServerId: null,
                savedJellyseerrSonarrProfileId: null,
                savedJellyseerrSonarrAnimeProfileId: null
            };

            // Tab switching functionality
            function switchTab(index) {
                // Hide all tab contents
                var tabContents = document.querySelectorAll('.tabContent');
                tabContents.forEach(function(content) {
                    content.style.display = 'none';
                });

                // Remove active class from all buttons
                var tabButtons = document.querySelectorAll('.localnav .emby-button');
                tabButtons.forEach(function(button) {
                    button.classList.remove('ui-btn-active');
                });

                // Show selected tab content
                var selectedContent = document.querySelector('.tabContent[data-index="' + index + '"]');
                if (selectedContent) {
                    selectedContent.style.display = 'block';
                }

                // Add active class to selected button
                var selectedButton = document.querySelector('.localnav .emby-button[data-index="' + index + '"]');
                if (selectedButton) {
                    selectedButton.classList.add('ui-btn-active');
                }
            }

            // Initialize tab buttons
            function initializeTabs() {
                var tabButtons = document.querySelectorAll('.localnav .emby-button');
                tabButtons.forEach(function(button) {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        var index = this.getAttribute('data-index');
                        switchTab(index);
                    });
                });

                // Ensure the first tab (General Settings) is visible by default
                switchTab(0);
            }

            // Utility function to format bytes
            function formatBytes(bytes) {
                if (bytes === 0) return '0 Bytes';
                var k = 1024;
                var sizes = ['Bytes', 'KB', 'MB', 'GB'];
                var i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            }

            // Load users into dropdown (used by Trakt and Trending tabs)
            function loadUsers() {
                return ApiClient.getUsers().then(function (users) {
                    var userSelector = document.getElementById('UserSelector');
                    if (userSelector) {
                        userSelector.innerHTML = '<option value="">Select a user...</option>';

                        users.forEach(function (user) {
                            var option = document.createElement('option');
                            option.value = user.Id;
                            option.textContent = user.Name;
                            userSelector.appendChild(option);
                        });
                    }

                    // Also populate trending movies user selector
                    var trendingUserSelector = document.getElementById('TrendingMoviesUser');
                    if (trendingUserSelector) {
                        trendingUserSelector.innerHTML = '<option value="">Select user for Trakt access...</option>';

                        users.forEach(function (user) {
                            var option = document.createElement('option');
                            option.value = user.Id;
                            option.textContent = user.Name;
                            trendingUserSelector.appendChild(option);
                        });
                    }
                });
            }

            // Tab loading state
            var tabsLoaded = {
                0: false,
                1: false,
                2: false,
                3: false
            };

            // Map tab index to tab name and file paths
            var tabConfig = {
                0: { name: 'general', html: 'tabs/general.html', js: 'tabs/general.js' },
                1: { name: 'trakt', html: 'tabs/trakt.html', js: 'tabs/trakt.js' },
                2: { name: 'trending', html: 'tabs/trending.html', js: 'tabs/trending.js' },
                3: { name: 'downloads', html: 'tabs/downloads.html', js: 'tabs/downloads.js' }
            };

            // Load tab content and script
            function loadTabContent(index) {
                if (tabsLoaded[index]) {
                    return Promise.resolve();
                }

                var config = tabConfig[index];
                if (!config) {
                    return Promise.reject('Invalid tab index: ' + index);
                }

                var container = document.querySelector('.tabContent[data-index="' + index + '"]');
                if (!container) {
                    return Promise.reject('Tab container not found for index: ' + index);
                }

                // Fetch HTML content
                return fetch(ApiClient.getUrl('JellyNext/Config/Tab/' + config.name))
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('Failed to load tab HTML: ' + response.statusText);
                        }
                        return response.text();
                    })
                    .then(function(html) {
                        // Inject HTML into container
                        container.innerHTML = html;

                        // Load and execute JavaScript
                        return new Promise(function(resolve, reject) {
                            var script = document.createElement('script');
                            script.src = ApiClient.getUrl('JellyNext/Config/Tab/' + config.name + '/js');
                            script.onload = function() {
                                // Call tab-specific init function
                                var initFunctionName = 'init' + config.name.charAt(0).toUpperCase() + config.name.slice(1) + 'Tab';
                                if (window[initFunctionName]) {
                                    window[initFunctionName]();
                                }
                                tabsLoaded[index] = true;
                                resolve();
                            };
                            script.onerror = function() {
                                reject(new Error('Failed to load tab script: ' + config.name));
                            };
                            document.body.appendChild(script);
                        });
                    });
            }

            // Load all tabs on page load (eager loading)
            function loadAllTabs() {
                return Promise.all([
                    loadTabContent(0),
                    loadTabContent(1),
                    loadTabContent(2),
                    loadTabContent(3)
                ]);
            }

            // Page initialization
            document.getElementById('JellyNextConfigPage').addEventListener('pageshow', function () {
                Dashboard.showLoadingMsg();

                // Initialize tabs (sets up tab switching)
                initializeTabs();

                var pluginConfig;

                // Load all tab content, then load data in proper order
                loadAllTabs().then(function() {
                    // Load plugin configuration first
                    return ApiClient.getPluginConfiguration(JellyNextConfig.pluginUniqueId);
                }).then(function(config) {
                    // Store config for later use
                    pluginConfig = config;

                    // Load users into dropdowns (returns a promise)
                    return loadUsers();
                }).then(function() {
                    // Now that users are loaded, populate settings from config
                    if (window.loadGeneralSettings) {
                        loadGeneralSettings(pluginConfig);
                    }
                    if (window.loadTrendingSettings) {
                        loadTrendingSettings(pluginConfig);
                    }
                    if (window.loadDownloadsConfig) {
                        loadDownloadsConfig(pluginConfig);
                    }

                    Dashboard.hideLoadingMsg();
                }).catch(function(error) {
                    console.error('Error loading configuration:', error);
                    Dashboard.hideLoadingMsg();
                    Dashboard.alert('Failed to load configuration: ' + error.message);
                });
            });

            // Save configuration on form submit
            document.getElementById('JellyNextConfigForm').addEventListener('submit', function (e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();

                ApiClient.getPluginConfiguration(JellyNextConfig.pluginUniqueId).then(function (config) {
                    // Save settings from each tab
                    if (window.saveGeneralSettings) {
                        saveGeneralSettings(config);
                    }
                    if (window.saveTrendingSettings) {
                        saveTrendingSettings(config);
                    }
                    if (window.saveDownloadsConfig) {
                        saveDownloadsConfig(config);
                    }

                    // Save plugin configuration
                    return ApiClient.updatePluginConfiguration(JellyNextConfig.pluginUniqueId, config);
                }).then(function (result) {
                    // If a user is selected in Trakt tab, save their per-user settings too
                    if (JellyNextConfig.currentUserGuid && window.saveUserTraktSettings) {
                        return saveUserTraktSettings(JellyNextConfig.currentUserGuid).then(function() {
                            return result;
                        });
                    }
                    return result;
                }).then(function(result) {
                    Dashboard.processPluginConfigurationUpdateResult(result);
                }).catch(function(error) {
                    console.error('Error saving configuration:', error);
                    Dashboard.hideLoadingMsg();
                    Dashboard.alert('Failed to save configuration: ' + error.message);
                });

                return false;
            });

            // Cleanup on page hide
            document.getElementById('JellyNextConfigPage').addEventListener('pagehide', function () {
                if (JellyNextConfig.authCheckInterval) {
                    clearInterval(JellyNextConfig.authCheckInterval);
                }
            });
        </script>
    </div>
</body>
</html>
