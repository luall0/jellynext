# CLAUDE.md

## Purpose
Context store for Claude Code sessions. Contains critical architecture decisions, patterns, and gotchas that must be maintained across sessions.

## Update Guidelines

**When to Update**: After new architectural patterns, major features, important technical decisions, or discovering critical gotchas.

**Include**: Architecture decisions (why, not what), non-obvious behaviors, critical constraints, key abstractions.

**Exclude**: Implementation details obvious from code, API docs (use code comments), change logs (use git), temporary TODOs.

### Git Commit Rules
- **NEVER use co-authoring** - Always commit as sole author, no "Co-authored-by" trailers
- **NEVER add "Generated by Claude Code"** - Describe the change only

### Code Documentation Rules
- **Do not over-document** - Only comment non-obvious logic, complex edge cases, and "why" decisions
- **No separate docs per feature** - Keep centralized in README.md
- Good code with clear naming > heavily commented code

---

## Project Overview

Jellyfin plugin integrating Trakt-powered discovery with per-user virtual libraries and one-click Radarr/Sonarr downloads.

**Tech Stack**: C# / .NET 9.0, Jellyfin Plugin SDK 10.11+, Trakt/TMDB/Radarr/Sonarr APIs

## Architecture

### Directory Structure
```
Jellyfin.Plugin.JellyNext/
├── Api/                    # REST API Controllers (Trakt, Radarr, Sonarr, JellyNextLibrary)
├── Configuration/          # Plugin settings (PluginConfiguration.cs, configPage.html)
├── Helpers/                # Utilities (UserHelper.cs)
├── Models/                 # Data models organized by service
│   ├── Common/             # ContentItem, ContentType
│   ├── Radarr/             # Movie, QualityProfile, RootFolder, etc.
│   ├── Sonarr/             # Series, Season, QualityProfile, etc.
│   └── Trakt/              # TraktUser, TraktMovie, TraktShow, TraktIds, etc.
├── Providers/              # Content provider implementations (IContentProvider)
├── Resources/              # Embedded resources (dummy.mp4)
├── ScheduledTasks/         # Background tasks (ContentSyncScheduledTask.cs)
├── Services/               # Business logic (TraktApi, ContentSync, Radarr/Sonarr, etc.)
├── VirtualLibrary/         # Virtual library system (Manager, Creator, ContentType)
├── Plugin.cs               # Main entry point
└── PluginServiceRegistrator.cs  # DI registration
```

### Key Components
- **Content Providers** (`IContentProvider`): Modular sources (RecommendationsProvider, NextSeasonsProvider)
- **Virtual Libraries**: Per-user .strm stub files (`jellynext-virtual/[userId]/[content-type]/`)
- **Playback Interception**: Detects virtual item playback, triggers Radarr/Sonarr downloads
- **OAuth**: Per-user Trakt tokens with auto-refresh (stored in `PluginConfiguration.TraktUsers[]`)
- **Sync System**: `ContentSyncScheduledTask` + `StartupSyncService` → cache → .strm files → library scan

### Architectural Layers
```
Plugin Entry → API Controllers → Services → Providers → Virtual Library → Jellyfin Core
                                     ↓
                              Playback Interceptor (triggers downloads)
```

**Layer Responsibilities**:
- **Entry**: `Plugin.cs` (singleton), `PluginServiceRegistrator.cs` (DI)
- **API**: REST endpoints for Trakt OAuth, Radarr/Sonarr operations, library queries
- **Services**: External integrations (TraktApi, RadarrService, SonarrService), orchestration (ContentSyncService), caching (ContentCacheService), library queries (LocalLibraryService)
- **Providers**: Pluggable content sources implementing `IContentProvider` (fetch recommendations, next seasons)
- **Virtual Library**: Stub file management (VirtualLibraryManager)
- **Playback Interceptor**: Event listener triggering downloads on virtual item playback

### File-by-File Responsibilities

**Core Entry Points**:
- `Plugin.cs`: Singleton instance, polling task tracking, configuration, web page registration
- `PluginServiceRegistrator.cs`: All DI registrations (services, providers, hosted services)

**API Controllers** (`/Api/`):
- `TraktController.cs`: OAuth device flow, token polling/refresh, user unlinking, per-user settings (GET/POST `/Users/{userGuid}/Settings`)
- `RadarrController.cs`: Connection test, profile/folder retrieval, movie downloads
- `SonarrController.cs`: Connection test, profile/folder retrieval, TV show/season downloads
- `JellyNextLibraryController.cs`: Query cached content (recommendations, next seasons)

**Services** (`/Services/`):
- `TraktApi.cs`: Trakt API client (OAuth, recommendations, watchlist, watched progress)
- `ContentCacheService.cs`: In-memory cache (per-user, per-provider, 6hr expiration)
- `ContentSyncService.cs`: Sync orchestrator (iterates users/providers, updates cache/virtual library)
- `RadarrService.cs`: Radarr API client (movie search/add)
- `SonarrService.cs`: Sonarr API client (series search/add, per-season monitoring, anime detection)
- `LocalLibraryService.cs`: Jellyfin library queries (find series by TVDB ID, exclude virtual items)
- `PlaybackInterceptor.cs`: IHostedService detecting virtual item playback, triggering downloads

**Providers** (`/Providers/`):
- `IContentProvider.cs`: Interface (ProviderName, LibraryName, FetchContentAsync, IsEnabledForUser)
- `RecommendationsProvider.cs`: Fetches Trakt recommendations, respects per-user `SyncMovieRecommendations`/`SyncShowRecommendations` flags and filters (`IgnoreCollected`, `IgnoreWatchlisted`)
- `NextSeasonsProvider.cs`: Fetches immediate next unwatched season, respects per-user `SyncNextSeasons` flag

**Virtual Library** (`/VirtualLibrary/`):
- `VirtualLibraryManager.cs`: Stub file creation/management, dummy.mp4 extraction, .keep file maintenance
- `VirtualLibraryCreator.cs`: Initialization wrapper
- `VirtualLibraryContentType.cs`: Enum (MoviesRecommendations, ShowsRecommendations, etc.)
- `VirtualLibraryContentTypeHelper.cs`: Maps content types to directories/providers/display names

**Jellyfin Integration**:
- `ScheduledTasks/ContentSyncScheduledTask.cs`: IScheduledTask (6hr interval, calls ContentSyncService, triggers library scan)

**Configuration**:
- `Configuration/PluginConfiguration.cs`: Persisted settings (Radarr/Sonarr config, TraktUsers[], cache expiration)
- `Configuration/configPage.html`: Embedded plugin UI
- `Helpers/UserHelper.cs`: Retrieves per-user Trakt config from PluginConfiguration

**Resources**:
- `Resources/dummy.mp4`: FFprobe-compatible placeholder (2x2px, 1hr, ~2MB) for iOS/tvOS compatibility

### Data Flow Examples

**Content Sync**:
```
StartupSyncService (5s delay) → ITaskManager.QueueScheduledTask<ContentSyncScheduledTask>
  → ContentSyncService.SyncAllAsync()
    → For each user + provider:
      IContentProvider.FetchContentAsync(userId)
        → TraktApi (fetch recommendations/next seasons)
        → LocalLibraryService (check existing library)
      ContentCacheService.CacheContent()
    → VirtualLibraryManager.RefreshVirtualLibrary() (create .strm stubs)
    → ILibraryManager.ValidateMediaLibrary() (trigger Jellyfin scan)
```

**Download Trigger**:
```
User plays virtual item → PlaybackStart event
  → PlaybackInterceptor.OnPlaybackStart()
    → Extract userId/contentType/IDs from path regex
    → ContentCacheService.GetCachedContent() (lookup metadata)
    → If movie: RadarrService.AddMovieAsync()
    → If show: SonarrService.AddSeriesAsync() (with season monitoring)

User stops playback → PlaybackStopped event
  → PlaybackInterceptor.OnPlaybackStopped()
    → Clear playback state (prevent "watched" marking)
```

**OAuth Flow**:
```
User → TraktController.AuthorizeUser(userGuid)
  → TraktApi.GetDeviceCodeAsync()
  → Return device code + verification URL

Background: Plugin.PollingTasks[userGuid] = TraktApi.PollForTokenAsync()
  → Every 5s: TraktApi.GetAccessTokenAsync()
  → On success: Save to PluginConfiguration.TraktUsers[]
```

## Critical Patterns & Gotchas

### HTTP Client - Cloudflare Bypass
**ALWAYS use `NamedClient.Default`**: `_httpClientFactory.CreateClient(NamedClient.Default)` - required for Trakt API (avoids Cloudflare blocks)

### Trakt API Headers
**Only two headers**: `trakt-api-version: 2` and `trakt-api-key: {client_id}` - do NOT add User-Agent/Accept (causes issues)

### Trakt Extended Metadata
**Use `extended=full`**: Required to retrieve genre data for anime detection - add to recommendations and watched shows endpoints

### Per-User Architecture
- Each user has own Trakt OAuth token (stored in `PluginConfiguration.TraktUsers[]`)
- Per-user sync settings: `SyncMovieRecommendations`, `SyncShowRecommendations`, `SyncNextSeasons`, `IgnoreCollected`, `IgnoreWatchlisted`, `LimitShowsToSeasonOne` (all in `TraktUser` model)
- Virtual libraries filtered by userId extracted from path
- Access via `UserHelper.GetTraktUser(userGuid)`
- Providers check `IsEnabledForUser()` which respects per-user sync flags

### Configuration Access
Use `Plugin.Instance?.Configuration` not `Plugin.Instance?.PluginConfiguration` - `BasePlugin<T>` exposes as `Configuration`

### Content Provider System
Implement `IContentProvider` + register in `PluginServiceRegistrator` → automatic sync/caching/error isolation

### OAuth Token Management
- 75% safety buffer before refresh (`ExpirationWithBuffer`)
- Trakt rotates refresh tokens on each refresh - **always save new tokens**
- Background polling tracked in `Plugin.Instance.PollingTasks`

### TV Show Downloads
- **Per-season monitoring**: Series `Monitored=true`, but only specific season has `Monitored=true` in seasons array
- **Anime detection**: Uses Trakt genre metadata (`ContentItem.Genres` contains "anime") to route to `SonarrAnimeRootFolderPath` vs `SonarrRootFolderPath`
- **"Next Up" prevention**: Clear playback state in `PlaybackStopped` event (not `PlaybackStart`)

### Next Seasons Discovery
- Only suggests **immediate next season** (not all missing seasons)
- Filters: aired episodes > 0, not in local library (via TVDB ID matching)
- Creates ONE stub per show (not seasons 1-10 like recommendations)

### Jellyfin 10.11 API Changes
- **UserDataManager**: Requires `User` entity (not `Guid`) - inject `IUserManager`, use `GetUserById(Guid)`
- **Task Triggers**: Use `TaskTriggerInfoType` enum, not string constants (`IntervalTrigger`, `DailyTrigger`, etc.)
- **Framework**: .NET 9.0 required

### Startup Sync Pattern
`StartupSyncService` (IHostedService) programmatically executes `ContentSyncScheduledTask` via `ITaskManager` - more reliable than `TriggerStartup` (only works on first registration)

### Virtual Library Stub Files
- **Path structure**: `jellynext-virtual/[userId]/[content-type]/`
- **Empty dirs**: Maintain `.keep` files (Jellyfin won't scan empty directories)
- **File formats**:
  - Movies: `Title (Year) [tmdbid-ID].strm`
  - Shows: `Title (Year) [tvdbid-ID]/S##E01 - Download Season #.strm` (seasons 1-10, or single stub for Next Seasons)
- **Regex patterns** (used by PlaybackInterceptor):
  - Path: `jellynext-virtual[/\\]([a-f0-9-]+)[/\\]([^/\\]+)[/\\]` (userId + content type)
  - Movie: `\[tmdbid-(\d+)\]$` | Show: `\[tvdbid-(\d+)\]$`
- **Native Resolution**: Jellyfin's default resolvers handle stub files automatically via standard naming conventions (`[tmdbid-X]` / `[tvdbid-X]` tags), no custom resolver needed

### FFprobe Compatibility (iOS/tvOS Fix)
- **Problem**: iOS/tvOS probe .strm files with FFprobe → crash on invalid/empty files
- **Solution**: Embed `dummy.mp4` (2x2, 1hr, ~2MB) as resource → extract to plugin data dir → point .strm files to it
- **Why**: FFprobe succeeds on valid MP4, PlaybackInterceptor still detects by path pattern
- **Side benefit**: 1-hour runtime prevents "watched" status (Jellyfin needs 5% = 3min)

---