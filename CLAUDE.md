# CLAUDE.md

## Purpose
Context store for Claude Code sessions. Contains critical architecture decisions, patterns, and gotchas that must be maintained across sessions.

## Update Guidelines

**When to Update**: After new architectural patterns, major features, important technical decisions, or discovering critical gotchas.

**Include**: Architecture decisions (why, not what), non-obvious behaviors, critical constraints, key abstractions.

**Exclude**: Implementation details obvious from code, API docs (use code comments), change logs (use git), temporary TODOs.

### Git Commit Rules
- **NEVER use co-authoring** - Always commit as sole author, no "Co-authored-by" trailers
- **NEVER add "Generated by Claude Code"** - Describe the change only

### Code Documentation Rules
- **Do not over-document** - Only comment non-obvious logic, complex edge cases, and "why" decisions
- **No separate docs per feature** - Keep centralized in README.md
- Good code with clear naming > heavily commented code

---

## Project Overview

Jellyfin plugin integrating Trakt-powered discovery with per-user virtual libraries and one-click Radarr/Sonarr downloads.

**Tech Stack**: C# / .NET 9.0, Jellyfin Plugin SDK 10.11+, Trakt/TMDB/Radarr/Sonarr APIs

## Architecture

### Directory Structure
```
Jellyfin.Plugin.JellyNext/
├── Api/                    # REST API Controllers (Trakt, Radarr, Sonarr, Jellyseerr, JellyNextLibrary, Config)
├── Configuration/          # Plugin settings (PluginConfiguration.cs, configPage.html, tabs/)
├── Helpers/                # Utilities (UserHelper.cs)
├── Models/                 # Data models organized by service
│   ├── Common/             # ContentItem, ContentType, ShowCacheEntry, SeasonMetadata, DownloadResult
│   ├── Jellyseerr/         # MediaRequest, JellyseerrUser, RadarrServer, SonarrServer, etc.
│   ├── Radarr/             # Movie, QualityProfile, RootFolder, etc.
│   ├── Sonarr/             # Series, Season, QualityProfile, etc.
│   └── Trakt/              # TraktUser, TraktMovie, TraktShow, TraktIds, TraktEpisode, TraktHistoryItem, etc.
├── Providers/              # Content provider implementations (IContentProvider)
├── Resources/              # Embedded resources (dummy.mp4)
├── ScheduledTasks/         # Background tasks (ContentSyncScheduledTask.cs)
├── Services/               # Business logic (TraktApi, ContentSync, Radarr/Sonarr, Jellyseerr, etc.)
│   └── DownloadProviders/  # IDownloadProvider, NativeDownloadProvider, JellyseerrDownloadProvider, WebhookDownloadProvider
├── VirtualLibrary/         # Virtual library system (Manager, Creator, ContentType)
├── Plugin.cs               # Main entry point
└── PluginServiceRegistrator.cs  # DI registration
```

### Key Components
- **Content Providers** (`IContentProvider`): Modular sources (RecommendationsProvider, NextSeasonsProvider, TrendingMoviesProvider)
- **Virtual Libraries**: Per-user .strm stub files (`jellynext-virtual/[userId]/[content-type]/`) + global content (`jellynext-virtual/global/[content-type]/`)
- **Download Providers** (`IDownloadProvider`): Pluggable download backends (NativeDownloadProvider for direct Radarr/Sonarr, JellyseerrDownloadProvider for Jellyseerr API, WebhookDownloadProvider for custom HTTP webhooks)
- **Playback Interception**: Detects virtual item playback, triggers downloads via selected provider
- **OAuth**: Per-user Trakt tokens with auto-refresh (stored in `PluginConfiguration.TraktUsers[]`)
- **Sync System**: `ContentSyncScheduledTask` + `StartupSyncService` → cache → .strm files → library scan

### Architectural Layers
```
Plugin Entry → API Controllers → Services → Providers → Virtual Library → Jellyfin Core
                                     ↓
                              Playback Interceptor (triggers downloads)
```

**Layer Responsibilities**:
- **Entry**: `Plugin.cs` (singleton), `PluginServiceRegistrator.cs` (DI)
- **API**: REST endpoints for Trakt OAuth, Radarr/Sonarr operations, library queries
- **Services**: External integrations (TraktApi, RadarrService, SonarrService), orchestration (ContentSyncService), caching (ContentCacheService), library queries (LocalLibraryService)
- **Providers**: Pluggable content sources implementing `IContentProvider` (fetch recommendations, next seasons)
- **Virtual Library**: Stub file management (VirtualLibraryManager)
- **Playback Interceptor**: Event listener triggering downloads on virtual item playback

### File-by-File Responsibilities

**Core Entry Points**:
- `Plugin.cs`: Singleton instance, polling task tracking, configuration, web page registration
- `PluginServiceRegistrator.cs`: All DI registrations (services, providers, hosted services)

**API Controllers** (`/Api/`):
- `TraktController.cs`: OAuth device flow, token polling/refresh, user unlinking, per-user settings (GET/POST `/Users/{userGuid}/Settings`)
- `RadarrController.cs`: Connection test, profile/folder retrieval, movie downloads (native integration)
- `SonarrController.cs`: Connection test, profile/folder retrieval, TV show/season downloads (native integration)
- `JellyseerrController.cs`: Connection test, server/profile retrieval for Radarr/Sonarr via Jellyseerr
- `JellyNextLibraryController.cs`: Query cached content (recommendations, next seasons)
- `ConfigController.cs`: Serves modular tab HTML/JS from embedded resources (no auth required - page already admin-only)

**Services** (`/Services/`):
- `TraktApi.cs`: Trakt API client (OAuth, recommendations, trending, watchlist, watched shows, seasons, watch history with auto-pagination)
- `ContentCacheService.cs`: In-memory cache for content items (per-user, per-provider, 6hr expiration)
- `ShowsCacheService.cs`: **Global season-level cache** + **per-user watch progress tracking**. Supports full sync (first run via `/sync/watched/shows`) and incremental sync (subsequent runs via `/sync/history/shows` with timestamps). Automatically handles ended vs ongoing shows, caching all seasons for ended shows and only complete seasons for ongoing shows. Tracks last sync timestamp in-memory for efficient delta syncing.
- `ContentSyncService.cs`: Sync orchestrator (iterates users/providers, updates cache/virtual library)
- `JellyseerrService.cs`: Jellyseerr API client (user import/management, movie/TV requests, server/profile retrieval)
- `RadarrService.cs`: Radarr API client (movie search/add) - native integration only
- `SonarrService.cs`: Sonarr API client (series search/add, per-season monitoring, anime detection) - native integration only
- `LocalLibraryService.cs`: Jellyfin library queries (find series by TVDB ID, exclude virtual items)
- `PlaybackInterceptor.cs`: IHostedService detecting virtual item playback, uses DownloadProviderFactory to route requests
- `DownloadProviderFactory.cs`: Factory selecting NativeDownloadProvider, JellyseerrDownloadProvider, or WebhookDownloadProvider based on config

**Providers** (`/Providers/`):
- `IContentProvider.cs`: Interface (ProviderName, LibraryName, FetchContentAsync, IsEnabledForUser)
- `RecommendationsProvider.cs`: Fetches Trakt recommendations, uses ShowsCacheService for season counts to avoid duplicate API calls
- `NextSeasonsProvider.cs`: Triggers ShowsCacheService sync, reads watched progress + season data from cache (no duplicate API calls). Dynamically fetches next season from Trakt if not in cache for ongoing shows.
- `TrendingMoviesProvider.cs`: Fetches Trakt trending movies (global, not per-user)

**Virtual Library** (`/VirtualLibrary/`):
- `VirtualLibraryManager.cs`: Stub file creation/management, dummy.mp4 extraction, .keep file maintenance, global content support
- `VirtualLibraryCreator.cs`: Initialization wrapper
- `VirtualLibraryContentType.cs`: Enum (MoviesRecommendations, ShowsRecommendations, MoviesTrending, etc.)
- `VirtualLibraryContentTypeHelper.cs`: Maps content types to directories/providers/display names, `IsGlobal()` helper

**Jellyfin Integration**:
- `ScheduledTasks/ContentSyncScheduledTask.cs`: IScheduledTask (6hr interval, calls ContentSyncService, triggers library scan)

**Configuration**:
- `Configuration/PluginConfiguration.cs`: Persisted settings (Radarr/Sonarr config, TraktUsers[], cache expiration). Profile IDs are nullable `int?` to support optional configs.
- `Configuration/configPage.html`: Main shell (317 lines) with inline shared utilities. Loads tab content via `ConfigController` endpoints.
- `Configuration/tabs/`: Modular tab files (general.html/js, trakt.html/js, trending.html/js, downloads.html/js) served as embedded resources
- `Helpers/UserHelper.cs`: Retrieves per-user Trakt config from PluginConfiguration

**Resources**:
- `Resources/dummy.mp4`: FFprobe-compatible placeholder (2x2px, 1hr, ~2MB) for iOS/tvOS compatibility

### Data Flow Examples

**Content Sync**:
```
StartupSyncService (5s delay) → ITaskManager.QueueScheduledTask<ContentSyncScheduledTask>
  → ContentSyncService.SyncAllAsync()
    → For each user + provider:
      IContentProvider.FetchContentAsync(userId)
        → TraktApi (fetch recommendations/next seasons)
        → LocalLibraryService (check existing library)
      ContentCacheService.CacheContent()
    → VirtualLibraryManager.RefreshVirtualLibrary() (create .strm stubs)
    → ILibraryManager.ValidateMediaLibrary() (trigger Jellyfin scan)
```

**Download Trigger**:
```
User plays virtual item → PlaybackStart event
  → PlaybackInterceptor.OnPlaybackStart()
    → Extract userId/contentType/IDs from path regex
    → ContentCacheService.GetCachedContent() (lookup metadata)
    → DownloadProviderFactory.GetProvider() (select Native, Jellyseerr, or Webhook)
    → IDownloadProvider.RequestMovieAsync() or RequestShowAsync()
      → NativeDownloadProvider: RadarrService/SonarrService direct API calls
      → JellyseerrDownloadProvider: JellyseerrService.RequestMovieAsync/RequestTvShowAsync()
        → Auto-import Jellyfin user if not in Jellyseerr (EnsureUserExistsAsync)
        → X-Api-User header for per-user attribution
      → WebhookDownloadProvider: HTTP request with placeholder replacement (URL/headers/payload)

User stops playback → PlaybackStopped event
  → PlaybackInterceptor.OnPlaybackStopped()
    → Clear playback state (prevent "watched" marking)
```

**OAuth Flow**:
```
User → TraktController.AuthorizeUser(userGuid)
  → TraktApi.GetDeviceCodeAsync()
  → Return device code + verification URL

Background: Plugin.PollingTasks[userGuid] = TraktApi.PollForTokenAsync()
  → Every 5s: TraktApi.GetAccessTokenAsync()
  → On success: Save to PluginConfiguration.TraktUsers[]
```

## Critical Patterns & Gotchas

### HTTP Client - Cloudflare Bypass
**ALWAYS use `NamedClient.Default`**: `_httpClientFactory.CreateClient(NamedClient.Default)` - required for Trakt API (avoids Cloudflare blocks)

### Trakt API Headers
**Only two headers**: `trakt-api-version: 2` and `trakt-api-key: {client_id}` - do NOT add User-Agent/Accept (causes issues)

### Trakt Extended Metadata
**Use `extended=full`**: Required to retrieve genre data for anime detection - add to recommendations and watched shows endpoints

### Per-User Architecture
- Each user has own Trakt OAuth token (stored in `PluginConfiguration.TraktUsers[]`)
- Per-user sync settings: `SyncMovieRecommendations`, `SyncShowRecommendations`, `SyncNextSeasons`, `IgnoreCollected`, `IgnoreWatchlisted`, `LimitShowsToSeasonOne`, `MovieRecommendationsLimit`, `ShowRecommendationsLimit`, `LastHistorySyncTimestamp` (all in `TraktUser` model)
- Recommendation limits: User-configurable 1-100 (default: 50), validated with `Math.Clamp()` on save
- Virtual libraries filtered by userId extracted from path
- Access via `UserHelper.GetTraktUser(userGuid)`
- Providers check `IsEnabledForUser()` which respects per-user sync flags

### Configuration Access
Use `Plugin.Instance?.Configuration` not `Plugin.Instance?.PluginConfiguration` - `BasePlugin<T>` exposes as `Configuration`

### Configuration Page Architecture
- **Modular tabs**: Each tab isolated in `Configuration/tabs/{name}.html` + `{name}.js` (general, trakt, trending, downloads)
- **Dynamic loading**: Main page fetches tabs via `ConfigController` (`GET /JellyNext/Config/Tab/{name}` and `/js`) using `ApiClient.getUrl()`
- **Eager loading**: All tabs loaded on pageshow, populated after users dropdown is ready (avoids race conditions)
- **Load order critical**: Load tabs → Load config → Load users → Populate UI (ensures dropdowns ready before setting values)
- **Tab functions**: Each exports `init{Tab}Tab()`, `load{Tab}Settings(config)`, `save{Tab}Settings(config)`
- **Nullable fields**: Radarr/Sonarr profile IDs are `int?` - validate empty strings before `parseInt()` to avoid `NaN`

### Content Provider System
Implement `IContentProvider` + register in `PluginServiceRegistrator` → automatic sync/caching/error isolation

### OAuth Token Management
- 75% safety buffer before refresh (`ExpirationWithBuffer`)
- Trakt rotates refresh tokens on each refresh - **always save new tokens**
- Background polling tracked in `Plugin.Instance.PollingTasks`

### Download Integration Modes
- **Native mode** (`DownloadIntegration=0`): Direct Radarr/Sonarr API integration (default for backward compatibility)
- **Jellyseerr mode** (`DownloadIntegration=1`): Routes all requests via Jellyseerr
  - **Auto-import**: Users auto-imported from Jellyfin on first request with REQUEST-only permissions
  - **User attribution**: X-Api-User header ensures requests tracked per Jellyfin user
  - **Config modes**:
    - **Default mode** (`UseJellyseerrRadarrDefaults=true`): Uses Jellyseerr's default server/profile settings
    - **Manual mode** (`UseJellyseerrRadarrDefaults=false`): Explicit server/profile selection from UI dropdowns
  - **Anime support**: Separate profile (`JellyseerrSonarrAnimeProfileId`) optional for anime routing
  - **GUID normalization**: Jellyseerr stores UUIDs without hyphens (73f7d5b9...), Jellyfin uses standard format (73f7d5b9-4d03-...)
- **Webhook mode** (`DownloadIntegration=2`): Custom HTTP webhooks for external integrations
  - **Placeholder support**: Movies: `{tmdbId}`, `{imdbId}`, `{title}`, `{year}`, `{jellyfinUserId}` | Shows: add `{tvdbId}`, `{seasonNumber}`, `{isAnime}`
  - **Configurable**: HTTP method (GET/POST/PUT/PATCH), custom headers, JSON payload templates
  - **Use case**: Integration with custom download systems, notification services, or third-party automation

### TV Show Downloads
- **Per-season monitoring**: Series `Monitored=true`, but only specific season has `Monitored=true` in seasons array (native mode)
- **Anime detection**: Uses Trakt genre metadata (`ContentItem.Genres` contains "anime")
  - **Native**: Routes to `SonarrAnimeRootFolderPath` vs `SonarrRootFolderPath`
  - **Jellyseerr**: Uses `JellyseerrSonarrAnimeProfileId` if configured, otherwise falls back to regular profile
- **"Next Up" prevention**: Clear playback state in `PlaybackStopped` event (not `PlaybackStart`)

### Next Seasons Discovery
- Only suggests **immediate next season** (not all missing seasons)
- Filters: aired episodes > 0, not in local library (via TVDB ID matching)
- Creates ONE stub per show (not seasons 1-10 like recommendations)
- **Sync-first approach**: Calls `ShowsCacheService.PerformIncrementalSync()` before fetching content (automatically handles full vs incremental)
- **Cache-only reads**: Retrieves watched progress + season metadata entirely from ShowsCacheService (no duplicate API calls)
- **Dynamic fetching**: If next season not in cache for ongoing shows, fetches latest from Trakt API via `GetShowSeasons()` and checks season count
- **Library deduplication**: Uses LocalLibraryService to exclude shows already in Jellyfin library (TVDB ID matching)

### Shows Cache (Season-Level)
- **Purpose**: Hybrid caching system with global show/season metadata + per-user watch progress tracking
- **Architecture**:
  - **Global cache**: `ConcurrentDictionary<int, ShowCacheEntry>` - shared show/season metadata (TVDB ID → entry)
  - **Per-user watch progress**: `ConcurrentDictionary<Guid, ConcurrentDictionary<int, int>>` - userId → (TVDB ID → highest watched season)
  - **In-memory timestamps**: `ConcurrentDictionary<Guid, DateTime>` - tracks last sync per user (NOT persisted to config)
- **Data models**:
  - `ShowCacheEntry`: Title, Year, IDs (TMDB/IMDB/TVDB/Trakt), Status, Genres, Seasons dictionary, CachedAt
  - `SeasonMetadata`: SeasonNumber, EpisodeCount, AiredEpisodes, FirstAired, CachedAt, IsComplete property
- **Sync strategy**:
  - **First run**: Full sync via `/sync/watched/shows?extended=full` → cache all shows + seasons + set watch progress
  - **Subsequent runs**: Incremental sync via `/sync/history/shows?start_at={timestamp}&end_at={timestamp}` → update only changed shows
  - **Pagination**: `GetShowWatchHistory` auto-fetches all pages (100 items/page, X-Pagination-Page-Count header)
- **Caching logic**:
  - **Ended/canceled shows**: Cache all seasons immediately (won't change)
  - **Ongoing shows**: Only cache complete seasons where `episode_count == aired_episodes`, update incomplete seasons if already cached
- **Timestamp management**: In-memory only (reset on restart → triggers full sync), set to `UtcNow - 1 minute` after each sync
- **Progressive discovery**: As user watches episodes, incremental sync detects progression → updates watch progress → triggers next season recommendations
- **API efficiency**: NextSeasonsProvider + RecommendationsProvider read from cache only (zero duplicate Trakt API calls during content fetch)

### Jellyfin 10.11 API Changes
- **UserDataManager**: Requires `User` entity (not `Guid`) - inject `IUserManager`, use `GetUserById(Guid)`
- **Task Triggers**: Use `TaskTriggerInfoType` enum, not string constants (`IntervalTrigger`, `DailyTrigger`, etc.)
- **Framework**: .NET 9.0 required

### Startup Sync Pattern
`StartupSyncService` (IHostedService) programmatically executes `ContentSyncScheduledTask` via `ITaskManager` - more reliable than `TriggerStartup` (only works on first registration)

### Virtual Library Stub Files
- **Path structure**:
  - Per-user: `jellynext-virtual/[userId]/[content-type]/`
  - Global: `jellynext-virtual/global/[content-type]/`
- **Empty dirs**: Maintain `.keep` files (Jellyfin won't scan empty directories)
- **File formats**:
  - Movies: `Title (Year) [tmdbid-ID].strm`
  - Shows: `Title (Year) [tvdbid-ID]/S##E01 - Download Season #.strm` (seasons 1-10, or single stub for Next Seasons)
- **Regex patterns** (used by PlaybackInterceptor):
  - Path: `jellynext-virtual[/\\]([a-f0-9-]+)[/\\]([^/\\]+)[/\\]` (userId + content type)
  - Movie: `\[tmdbid-(\d+)\]$` | Show: `\[tvdbid-(\d+)\]$`
- **Native Resolution**: Jellyfin's default resolvers handle stub files automatically via standard naming conventions (`[tmdbid-X]` / `[tvdbid-X]` tags), no custom resolver needed

### Global Content Types
- **Purpose**: Shared content across all users (e.g., trending movies)
- **Configuration**: Global settings in `PluginConfiguration` (not per-user)
- **Path**: `jellynext-virtual/global/movies_trending`
- **Source User**: Requires one Trakt-authenticated user for API access (`TrendingMoviesUserId`)
- **Auto-initialization**: Directory created on plugin startup if enabled (`InitializeGlobalDirectories()`)

### FFprobe Compatibility (iOS/tvOS Fix)
- **Problem**: iOS/tvOS probe .strm files with FFprobe → crash on invalid/empty files
- **Solution**: Two embedded dummy videos:
  - `dummy_short.mp4` (2x2, 2sec, ~5KB) - auto-stops playback on clients without API stop support
  - `dummy.mp4` (2x2, 1hr, ~2MB) - prevents "watched" status (needs 5% = 3min), requires manual stop
- **Configuration**: `UseShortDummyVideo` (default: true) - toggles between short/long dummy
- **Auto-rebuild**: Changing config triggers full stub refresh via `DoesStubContentMatch()` check

### Cache Architecture Refactoring (v1.1.1+)
**Migration from EndedShowsCacheService to ShowsCacheService**:
- **Old approach**: Separate `EndedShowsCacheService` with complex custom caching logic, stored `EndedShowMetadata` in config
- **New approach**: Unified `ShowsCacheService` with hybrid architecture (global show cache + per-user watch progress)
- **Key improvements**:
  - **Separation of concerns**: Global metadata cached once (shared across users) vs per-user watch progress tracked separately
  - **In-memory timestamps**: Last sync timestamp no longer persisted to config (cleaner, triggers full sync on restart for freshness)
  - **Incremental sync**: History-based delta syncing via `/sync/history/shows` reduces API load
  - **Smart caching**: Ended shows cache all seasons, ongoing shows only cache complete seasons (avoid stale data)
  - **Automatic sync mode**: `PerformIncrementalSync()` internally detects first run and falls back to full sync
  - **Zero duplicate API calls**: Both NextSeasonsProvider and RecommendationsProvider read from same cache
- **Deleted files**: `EndedShowsCacheService.cs`, `EndedShowMetadata.cs` (replaced by `ShowsCacheService.cs`, `ShowCacheEntry.cs`, `SeasonMetadata.cs`)
- **New models**: `TraktHistoryItem.cs`, `TraktEpisode.cs` (for history endpoint parsing)
- **API additions**: `TraktApi.GetShowWatchHistory()` with automatic pagination support

---