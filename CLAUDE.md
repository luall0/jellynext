# CLAUDE.md

## Purpose
Context store for Claude Code sessions. Contains critical architecture decisions, patterns, and gotchas that must be maintained across sessions.

## Update Guidelines

**When to Update**: After new architectural patterns, major features, important technical decisions, or discovering critical gotchas.

**Include**: Architecture decisions (why, not what), non-obvious behaviors, critical constraints, key abstractions.

**Exclude**: Implementation details obvious from code, API docs (use code comments), change logs (use git), temporary TODOs.

### Git Commit Rules
- **NEVER use co-authoring** - Always commit as sole author, no "Co-authored-by" trailers
- **NEVER add "Generated by Claude Code"** - Describe the change only

### Code Documentation Rules
- **Do not over-document** - Only comment non-obvious logic, complex edge cases, and "why" decisions
- **No separate docs per feature** - Keep centralized in README.md
- Good code with clear naming > heavily commented code

---

## Project Overview

Jellyfin plugin integrating Trakt-powered discovery with per-user virtual libraries and one-click Radarr/Sonarr downloads.

**Tech Stack**: C# / .NET 9.0, Jellyfin Plugin SDK 10.11+, Trakt/TMDB/Radarr/Sonarr APIs

## Architecture

### Key Components
- **Content Providers** (`IContentProvider`): Modular sources (RecommendationsProvider, NextSeasonsProvider)
- **Virtual Libraries**: Per-user .strm stub files (`jellynext-virtual/[userId]/[content-type]/`)
- **Playback Interception**: Detects virtual item playback, triggers Radarr/Sonarr downloads
- **OAuth**: Per-user Trakt tokens with auto-refresh (stored in `PluginConfiguration.TraktUsers[]`)
- **Sync System**: `ContentSyncScheduledTask` + `StartupSyncService` → cache → .strm files → library scan

## Critical Patterns & Gotchas

### HTTP Client - Cloudflare Bypass
**ALWAYS use `NamedClient.Default`**: `_httpClientFactory.CreateClient(NamedClient.Default)` - required for Trakt API (avoids Cloudflare blocks)

### Trakt API Headers
**Only two headers**: `trakt-api-version: 2` and `trakt-api-key: {client_id}` - do NOT add User-Agent/Accept (causes issues)

### Per-User Architecture
- Each user has own Trakt OAuth token (stored in `PluginConfiguration.TraktUsers[]`)
- Virtual libraries filtered by userId extracted from path
- Access via `UserHelper.GetTraktUser(userGuid)`

### Configuration Access
Use `Plugin.Instance?.Configuration` not `Plugin.Instance?.PluginConfiguration` - `BasePlugin<T>` exposes as `Configuration`

### Content Provider System
Implement `IContentProvider` + register in `PluginServiceRegistrator` → automatic sync/caching/error isolation

### OAuth Token Management
- 75% safety buffer before refresh (`ExpirationWithBuffer`)
- Trakt rotates refresh tokens on each refresh - **always save new tokens**
- Background polling tracked in `Plugin.Instance.PollingTasks`

### TV Show Downloads
- **Per-season monitoring**: Series `Monitored=true`, but only specific season has `Monitored=true` in seasons array
- **Anime detection**: Title heuristics determine `SonarrAnimeRootFolderPath` vs `SonarrRootFolderPath`
- **"Next Up" prevention**: Clear playback state in `PlaybackStopped` event (not `PlaybackStart`)

### Next Seasons Discovery
- Only suggests **immediate next season** (not all missing seasons)
- Filters: aired episodes > 0, not in local library (via TVDB ID matching)
- Creates ONE stub per show (not seasons 1-10 like recommendations)

### Jellyfin 10.11 API Changes
- **UserDataManager**: Requires `User` entity (not `Guid`) - inject `IUserManager`, use `GetUserById(Guid)`
- **Task Triggers**: Use `TaskTriggerInfoType` enum, not string constants (`IntervalTrigger`, `DailyTrigger`, etc.)
- **Framework**: .NET 9.0 required

### Startup Sync Pattern
`StartupSyncService` (IHostedService) programmatically executes `ContentSyncScheduledTask` via `ITaskManager` - more reliable than `TriggerStartup` (only works on first registration)

### Virtual Library Stub Files
- **Path structure**: `jellynext-virtual/[userId]/[content-type]/`
- **Empty dirs**: Maintain `.keep` files (Jellyfin won't scan empty directories)
- **File formats**:
  - Movies: `Title (Year) [tmdbid-ID].strm`
  - Shows: `Title (Year) [tvdbid-ID]/S##E01 - Download Season #.strm` (seasons 1-10, or single stub for Next Seasons)
- **Regex patterns**:
  - Path: `jellynext-virtual[/\\]([a-f0-9-]+)[/\\]([^/\\]+)[/\\]` (userId + content type)
  - Movie: `\[tmdbid-(\d+)\]$` | Show: `\[tvdbid-(\d+)\]$`
- **Provider IDs required**: Movies need TMDB+IMDB, Shows need TVDB+TMDB+IMDB

### FFprobe Compatibility (iOS/tvOS Fix)
- **Problem**: iOS/tvOS probe .strm files with FFprobe → crash on invalid/empty files
- **Solution**: Embed `dummy.mp4` (2x2, 1hr, ~2MB) as resource → extract to plugin data dir → point .strm files to it
- **Why**: FFprobe succeeds on valid MP4, PlaybackInterceptor still detects by path pattern
- **Side benefit**: 1-hour runtime prevents "watched" status (Jellyfin needs 5% = 3min)

---